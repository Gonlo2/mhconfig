<!DOCTYPE html><html lang=en_US> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Documentation | MHConfig</title><link rel="shortcut icon" href=/mhconfig/img/ico/favicon.ico type=image/vnd.microsoft.icon><link rel=icon sizes=16x16 href=/mhconfig/img/ico/favicon-16x16.png><link rel=icon sizes=32x32 href=/mhconfig/img/ico/favicon-32x32.png><link rel=icon sizes=256x256 href=/mhconfig/img/ico/favicon.png><link rel=apple-touch-icon sizes=256x256 href=/mhconfig/img/ico/favicon.png><meta name=theme-color content=#3273dc><link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel=stylesheet><link rel=stylesheet href=/mhconfig/css/bulma.min.css><link rel=stylesheet href=/mhconfig/css/fontawesome.min.css><link rel=stylesheet href=/mhconfig/css/main.min.css></head> <body> <div class=page-container> <div class=content-wrapper> <nav class=navbar role=navigation aria-label="main navigation"> <div class=container> <div class=navbar-brand> <a href=/mhconfig/ class=navbar-item> <img class=img-fluid src=/mhconfig/img/logo/header.png alt=Logo> </a> <a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbar> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a> </div> <div id=navbar class=navbar-menu> <div class=navbar-end> <a href=/mhconfig/en/doc/ class=navbar-item> <span class=icon> <i class="fas fa-book"></i> </span> <span>Documentation</span> </a> <div class=buttons> <a class=button href=https://github.com/Gonlo2/mhconfig> <span class=icon> <i class="fab fa-github"></i> </span> <span>GitHub</span> </a> </div> </div> </div> </div> </nav> <noscript> <p class=enable-js>Enable JavaScript in your browser for a better experience.</p> </noscript> <section class="section has-background-light" id=doc> <div class="columns reverse-column-order-mobile"> <div class="column  is-8-tablet is-7-widescreen  is-offset-1-tablet is-offset-2-widescreen"> <div class=content> <h1 id=getting-started>Getting Started</h1> <h2 id=prerequisites>Prerequisites</h2> <p>This service need cmake and a c++ compiler, to facilitate the build process a docker image with all the requirements is provided, in this case you only need to have installed docker, docker-compose and <a href=https://github.com/Gonlo2/an-ci>an-ci</a>.</p> <p>First of all you need to build the docker-image</p> <div class=codehilite><pre><span></span><code><span class=nb>cd</span> dockerfiles/cpp-builder/
docker build -t mhconfig-builder:0.3  .
</code></pre></div> <p>After that go to the root path, prepare the thirdparties and build the server</p> <div class=codehilite><pre><span></span><code><span class=nb>cd</span> ../..
git submodule update --init
an-ci third_party
an-ci build
</code></pre></div> <p>You could find the executable in <code>./build/mhconfig</code></p> <h2 id=execution>Execution</h2> <p>It's possible to run the program in two modes, server and local.</p> <h3 id=server>Server</h3> <p>The program creates a grpc server that takes care of calculating and responding to the configuration.</p> <div class=codehilite><pre><span></span><code>./mhconfig server &lt;daemon config path&gt; &lt;gRPC listen address&gt; &lt;prometheus listen address&gt; &lt;num grpc threads&gt; &lt;num workers&gt;
</code></pre></div> <p>For example</p> <div class=codehilite><pre><span></span><code><span class=nv>SPDLOG_LEVEL</span><span class=o>=</span>debug ./mhconfig server daemon_config <span class=m>0</span>.0.0.0:2222 <span class=m>0</span>.0.0.0:1111 <span class=m>13</span> <span class=m>13</span>
</code></pre></div> <p>To test it you could implement a client using the protobuf file <code>./src/mhconfig/proto/mhconfig.proto</code> or using some tool like <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> or <a href=https://ghz.sh/ >ghz</a>.</p> <p>PS: the logger configuration format could be obtained from <a href=https://github.com/gabime/spdlog/releases/tag/v1.6.0>spdlog</a>.</p> <p>PS2: for the moment it isn't possible to reload the configuration of the daemon.</p> <h3 id=local>Local</h3> <p>The program calculates the overrides passed by the standard input and returns them as yaml documents by the standard output, separating the arguments blocks by spaces.</p> <p>The arguments it read are:</p> <ul> <li>The first line is the root path of the configuration as a absolute path.</li> <li>The second line is document name of the files to calculate the overrides.</li> <li>The rest of lines are the labels to use for the overrides with the format &lt;key&gt;/&lt;value&gt;.</li> </ul> <p>For example</p> <div class=codehilite><pre><span></span><code><span class=nv>SPDLOG_LEVEL</span><span class=o>=</span>debug ./mhconfig <span class=nb>local</span>
</code></pre></div> <p>Where with the input</p> <div class=codehilite><pre><span></span><code>/mnt/mhconfig/config
database
app/calendar
env/dev

/mnt/mhconfig/config
this_doc_dont_exists
app/calendar
env/dev
</code></pre></div> <p>It prints</p> <div class=codehilite><pre><span></span><code><span class=nn>---</span>
<span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">4322</span>
<span class=nt>database</span><span class=p>:</span> <span class=s>&quot;test_calendar&quot;</span>
<span class=nt>host</span><span class=p>:</span> <span class=s>&quot;127.0.0.1&quot;</span>
<span class=nt>table</span><span class=p>:</span> <span class=s>&quot;days&quot;</span>
<span class=nn>...</span>
<span class=nn>---</span>
<span class=kt>!undefined</span> <span class="l l-Scalar l-Scalar-Plain">~</span>
<span class=nn>...</span>
</code></pre></div> <h1 id=configuration>Configuration</h1> <p>The configuration use YAML files and the mapping between files and configuration is simple, the file name is the first level of the configuration and the file content is appended to this first level.</p> <h2 id=labels>Labels</h2> <p>The labels allow you to define specific characteristics of the configuration to be created, for example the type of environment, the name of the service, the type of secrets, etc.</p> <p>The algorithm used to calculate the order of the configurations is as follows.</p> <ul> <li>All stored configurations that are a subset of the requested labels are obtained.</li> <li>Those configurations are first ordered by the number of labels that form it, from less to more specialization.</li> <li>For those configurations with the same number of labels, an ordered list with the weights of the label keys is created and the configurations are ordered with respect to this list.</li> </ul> <p>For this it is necessary to have a configuration with metadata of the labels as their weight, this content has to be stored in the <code>mhconfig.yaml</code> document of the root of the configuration. This file has the structure:</p> <div class=codehilite><pre><span></span><code><span class=nt>labels_metadata</span><span class=p>:</span>
  <span class=nt>low</span><span class=p>:</span>
    <span class=nt>weight</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=nt>high</span><span class=p>:</span>
    <span class=nt>weight</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
</code></pre></div> <p>The labels are represented in a hierarchical way in the directory tree, being able to represent the label with key <code>env</code> and value <code>dev</code> in two ways, with the folders <code>env/dev</code> or with the folder <code>env=dev</code>. You can find some examples in the <a href=https://github.com/Gonlo2/mhconfig/tree/development/examples/config>examples folder</a>.</p> <h2 id=tags>Tags</h2> <p>Some custom tags are allowed to facilitate the configuration administration.</p> <ul> <li><code>!format</code> allow format a string with some parameters.</li> <li><code>!ref</code> insert the configuration of another file if don't exists a circular dependency.</li> <li><code>!sref</code> insert a scalar or a null value from the same configuration file.</li> <li><code>!delete</code> remove the previous element with that path.</li> <li><code>!override</code> force override one value instead merge it.</li> <li><code>!!str</code>, <code>!!binary</code>, <code>!!int</code>, <code>!!float</code> and <code>!!bool</code> defines the type of a scalar.</li> </ul> <h3 id=format>Format</h3> <p>The <code>!format</code> tag allow create a string from some named variables and it works by adding the scalar of the path enclosed in parentheses. The syntax is the next:</p> <div class=codehilite><pre><span></span><code><span class=kt>!format</span> <span class=s>&quot;{database/host}:{database/port}</span><span class=nv> </span><span class=s>(database:</span><span class=nv> </span><span class=s>{database/database},</span><span class=nv> </span><span class=s>table:</span><span class=nv> </span><span class=s>{database/table})&quot;</span>
</code></pre></div> <p>So if you have a document named <code>database</code> with the content</p> <div class=codehilite><pre><span></span><code><span class=nt>host</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
<span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2332</span>
<span class=nt>database</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test_me</span>
<span class=nt>table</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">items</span>
</code></pre></div> <p>It make the scalar <code>127.0.0.1:2332 (database: test_me, table: items)</code>.</p> <h3 id=reference-and-scalar-reference>Reference and scalar reference</h3> <p>The tag <code>!ref</code> allow use some configuration provided in another configuration file if don't exists circular dependencies, also it's possible override that configuration in a next override. Like in some cases it's necessary reuse some value provided in the same configuration document the <code>!sref</code> allow do that but only if the referenced element is a scalar or null.</p> <h3 id=delete>Delete</h3> <p>If it's necessary remove the content of a previous override it's possible do that with the <code>!delete</code> tag.</p> <h3 id=override>Override</h3> <p>By default only it's possible merge values of the same kind with the overrides, to force the override it's necessary use the tag <code>!override</code>.</p> <h2 id=special-files>Special files</h2> <p>By default only configuration files with the <code>.yaml</code> extension are read, but it is possible to specify that a file is special if it starts with a underscore. These files follow the same logic as configuration files but have a prefix (the special file type) and a suffix (the file extension), and at the moment there are two: binary files and text files.</p> <p>For example, file <code>_bin.secret.p12</code> would be a binary file, with the document name <code>_bin.secret.p12</code>.</p> <h2 id=restrictions>Restrictions</h2> <p>The overrides have some restrictions:</p> <ul> <li>A scalar or null value can only be overwritten with another scalar or null value, if you want to overwrite it you have to use the <code>!override</code> tag to force it.</li> <li>A map or a list can only be merged with another element of the same type, if you want to overwrite it you must use the <code>!override</code> tag.</li> <li>The <code>!ref</code> tag can only be used if the resulting configuration does not have cycles, that is, you cannot refer to a configuration directly or indirectly uses the self configuration.</li> <li>You can only use the sref tag for scalars in the document.</li> </ul> <h2 id=debug>Debug</h2> <p>To help debug the returned configuration and what operations have been performed there is a logger system to help debug the returned configuration and what operations have been performed and it allows you to obtain:</p> <ul> <li>The importance of notification, which has the <code>error</code>, <code>warn</code>, <code>info</code>, <code>debug</code> and <code>trace</code> level.</li> <li>A message with a description.</li> <li>Optionally the file with the line and column where the element is defined.</li> <li>Optionally the file with the line and column of the element affecting the previous one.</li> </ul> <p>In addition to the logger system, it is possible to obtain the file, the line and the column of the returned elements if a level equal or higher than <code>info</code> is requested.</p> <p>It's possible to find a basic client to check the configuration in <code>client/python/</code> that allow use a git blame like and logger to check the operations. An example of its use can be:</p> <div class=codehilite><pre><code><font color=#55FF55><b>➜  </b></font><font color=#55FFFF><b>python</b></font> MHCONFIG_AUTH_TOKEN=minimal python checker.py /mnt/data/mhconfig test low/priority high/priority --log-level trace
f3ce5ea3 low=priority/test.yaml:2:3         1) &quot;hola&quot;:
79c10114 low=priority/mio.yaml:1:1          2)     &quot;aaaaa&quot;:
79c10114 low=priority/mio.yaml:1:11         3)         &quot;database&quot;: &quot;test&quot;
79c10114 low=priority/mio.yaml:3:7          4)         &quot;host&quot;: &quot;127.0.0.1&quot;
79c10114 low=priority/mio.yaml:4:7          5)         &quot;port&quot;: 1111
79c10114 low=priority/mio.yaml:2:8          6)         &quot;table&quot;: &quot;whatever&quot;
f3ce5ea3 low=priority/test.yaml:6:10        7)     &quot;adios&quot;: &quot;hola&quot;
12f8bd15 high/priority/test.yaml:5:10       8)     &quot;mundo&quot;: &quot;tuyo&quot;
12f8bd15 high/priority/test.yaml:7:7        9)     &quot;o2&quot;: &quot;127.0.0.1:1111 (database: test, table: whatever)&quot;
f3ce5ea3 low=priority/test.yaml:3:10       10)     &quot;perro&quot;: &quot;o_no&quot;
12f8bd15 high/priority/test.yaml:6:8       11)     &quot;seq&quot;:
12f8bd15 high/priority/test.yaml:6:9       12)         - null
f3ce5ea3 low=priority/test.yaml:7:16       13)     &quot;some_binary&quot;: !!binary |-
f3ce5ea3 low=priority/test.yaml:7:16       14)         TG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNldGV0dXIgc2FkaXBzY2luZyBlbGl0ciwg
f3ce5ea3 low=priority/test.yaml:7:16       15)         c2VkIGRpYW0gbm9udW15IGVpcm1vZCB0ZW1wb3IgaW52aWR1bnQgdXQgbGFib3JlIGV0IGRvbG9y
f3ce5ea3 low=priority/test.yaml:7:16       16)         ZSBtYWduYSBhbGlxdXlhbSBlcmF0LCBzZWQgZGlhbSB2b2x1cHR1YS4gQXQgdmVybyBlb3MgZXQg
f3ce5ea3 low=priority/test.yaml:7:16       17)         YWNjdXNhbSBldCBqdXN0byBkdW8gZG9sb3JlcyBldCBlYSByZWJ1bS4gU3RldCBjbGl0YSBrYXNk
f3ce5ea3 low=priority/test.yaml:7:16       18)         IGd1YmVyZ3Jlbiwgbm8gc2VhIHRha2ltYXRhIHNhbmN0dXMgZXN0IExvcmVtIGlwc3VtIGRvbG9y
f3ce5ea3 low=priority/test.yaml:7:16       19)         IHNpdCBhbWV0Lgo=
75ea914e low=priority/_text.name.ext:1:1   20)     &quot;some_external_file&quot;: &quot;I&apos;m a text file\n&quot;
f3ce5ea3 low=priority/test.yaml:3:10       21)     &quot;test&quot;: &quot;o_no&quot;
12f8bd15 high/priority/test.yaml:3:5       22)     &quot;to_delete&quot;:
12f8bd15 high/priority/test.yaml:3:7       23)         -
12f8bd15 high/priority/test.yaml:4:14      24)             &quot;adios&quot;: 2

<b>d7c5a0dd: mhconfig.yaml:3:13: </b><font color=#AAAAAA><b>trace: </b></font><b>Created int64 value from plain scalar</b>
    weight: 1
            <font color=#55FF55><b>^</b></font>
<b>d7c5a0dd: mhconfig.yaml:3:5: </b><font color=#AAAAAA><b>trace: </b></font><b>Created map value</b>
    weight: 1
    <font color=#55FF55><b>^</b></font>
<b>d7c5a0dd: mhconfig.yaml:5:13: </b><font color=#AAAAAA><b>trace: </b></font><b>Created int64 value from plain scalar</b>
    weight: 2
            <font color=#55FF55><b>^</b></font>
<b>d7c5a0dd: mhconfig.yaml:5:5: </b><font color=#AAAAAA><b>trace: </b></font><b>Created map value</b>
    weight: 2
    <font color=#55FF55><b>^</b></font>
...

<b>f3ce5ea3: low=priority/test.yaml:2:3: </b><font color=#55FFFF><b>debug: </b></font><b>Adding new map key</b>
  mundo: whatever
<font color=#55FF55><b>  ^----|</b></font>
  seq: [~]  # 12f8bd15: high/priority/test.yaml:6:8

<b>f3ce5ea3: low=priority/test.yaml:2:3: </b><font color=#55FFFF><b>debug: </b></font><b>Adding new map key</b>
  mundo: whatever
<font color=#55FF55><b>  ^-|</b></font>
    - hola: !delete  # 12f8bd15: high/priority/test.yaml:3:5

<b>12f8bd15: high/priority/test.yaml:3:13: </b><font color=#FF55FF><b>warn: </b></font><b>Removing an unused deletion node</b>
    - hola: !delete
            <font color=#55FF55><b>^</b></font>
<b>f3ce5ea3: low=priority/test.yaml:4:10: </b><font color=#55FFFF><b>debug: </b></font><b>Applied ref</b>
  aaaaa: !ref [mio]
<font color=#55FF55><b>|--------^</b></font>
database: test  # 79c10114: low=priority/mio.yaml:1:1

<b>f3ce5ea3: low=priority/test.yaml:14:23: </b><font color=#55FFFF><b>debug: </b></font><b>Applied ref</b>
  some_external_file: !ref [_text.name.ext]
<font color=#55FF55><b>|---------------------^</b></font>
I&apos;m a text file  # 75ea914e: low=priority/_text.name.ext:1:1

<b>f3ce5ea3: low=priority/test.yaml:5:9: </b><font color=#55FFFF><b>debug: </b></font><b>Applied sref</b>
  test: !sref [hola, perro]
<font color=#55FF55><b>        ^|</b></font>
  perro: o_no  # f3ce5ea3: low=priority/test.yaml:3:10

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Applied ref</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
<font color=#55FF55><b>      ^</b></font>
host: 127.0.0.1  # 79c10114: low=priority/mio.yaml:3:7

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Applied ref</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
<font color=#55FF55><b>      ^</b></font>
port: 1111  # 79c10114: low=priority/mio.yaml:4:7

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Applied ref</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
<font color=#55FF55><b>      ^---|</b></font>
database: test  # 79c10114: low=priority/mio.yaml:1:11

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Applied ref</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
<font color=#55FF55><b>      ^|</b></font>
table: whatever  # 79c10114: low=priority/mio.yaml:2:8

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Obtained template parameter</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
<font color=#55FF55><b>      ^</b></font>
host: 127.0.0.1  # 79c10114: low=priority/mio.yaml:3:7

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Obtained template parameter</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
<font color=#55FF55><b>      ^</b></font>
port: 1111  # 79c10114: low=priority/mio.yaml:4:7

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Obtained template parameter</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
<font color=#55FF55><b>      ^---|</b></font>
database: test  # 79c10114: low=priority/mio.yaml:1:11

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Obtained template parameter</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
<font color=#55FF55><b>      ^|</b></font>
table: whatever  # 79c10114: low=priority/mio.yaml:2:8

<b>12f8bd15: high/priority/test.yaml:7:7: </b><font color=#55FFFF><b>debug: </b></font><b>Formated string</b>
  o2: !format &quot;{mio/host}:{mio/port} (database: {mio/database}, table: {mio/table})&quot;
      <font color=#55FF55><b>^</b></font>
</code></pre></div> <h1 id=access-control-lists>Access Control Lists</h1> <p>It is possible to configure the server to control access to sensitive resources or procedures, that said, the permission logic can be divided into the following parts: tokens and policies.</p> <h2 id=tokens>Tokens</h2> <p>A token allows to authenticate an entity and configure some authentication parameters, although at the moment it only allows you to define the expiration date of the token through a unix timestamp. The tokens are defined in the <code>tokens.yaml</code> root file of the configuration folder as a YAML file, this file has the following structure:</p> <div class=codehilite><pre><span></span><code><span class=nt>tokens</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
  <span class=nt>expire_at</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="p p-Indicator">-</span> <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">dev</span>
  <span class=nt>expire_at</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">developer</span>
    <span class=nt>env</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">dev</span>
<span class="p p-Indicator">-</span> <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">calendar-prod</span>
  <span class=nt>expire_at</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">app</span>
    <span class=nt>env</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">prod</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">calendar</span>
</code></pre></div> <p>Each token has an associated expiration date and the labels to be used in the configuration folder to obtain the configuration of the request.</p> <h2 id=policies>Policies</h2> <p>A policy allows you to restrict access to resources based on the capabilities, the root path and the labels, and it has the following structure:</p> <div class=codehilite><pre><span></span><code><span class=nt>capabilities</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=nv>GET</span><span class="p p-Indicator">,</span> <span class=nv>WATCH</span><span class="p p-Indicator">,</span> <span class=nv>TRACE</span><span class="p p-Indicator">]</span>
<span class=nt>root_paths</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/mnt/data/mhconfig/+</span>
  <span class=nt>capabilities</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=nv>GET</span><span class="p p-Indicator">,</span> <span class=nv>WATCH</span><span class="p p-Indicator">,</span> <span class=nv>TRACE</span><span class="p p-Indicator">]</span>
<span class=nt>labels</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
  <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">me</span>
  <span class=nt>capabilities</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=nv>GET</span><span class="p p-Indicator">,</span> <span class=nv>WATCH</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
  <span class=nt>capabilities</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=nv>GET</span><span class="p p-Indicator">,</span> <span class=nv>WATCH</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>capabilities</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=nv>GET</span><span class="p p-Indicator">,</span> <span class=nv>WATCH</span><span class="p p-Indicator">,</span> <span class=nv>TRACE</span><span class="p p-Indicator">]</span>
</code></pre></div> <p>Where the possible capabilities are: <code>GET</code>, <code>WATCH</code>, <code>TRACE</code>, <code>UPDATE</code> (it only check the <code>root_path</code>) and <code>RUN_GC</code> (it only check the entity capability).</p> <p>A path could have two special characters:</p> <ul> <li>The character <code>+</code> to denote any value within a single path segment.</li> <li>The character <code>*</code> to denote any number of path segments, this can only be used at the end of the path.</li> </ul> <p>And a label rule that don't have a key affects all the labels, one with key but without value affect all the labels with that key and another with a key and value affect only to that values.</p> <p>PS: Take in mind that because the list merge logic the lists are read in reverse order.</p> <h1 id=api>API</h1> <p>A gRPC API is used to communicate with the daemon, where most of the methods that make use of a configuration path return a namespace identifier. This value is a 64bits unsigned integer generated randomly and its purpose is to tell the client if the previously asked information is still valid.</p> <p>Also this kind of responses return a version number that allow reproducible results for some time in the case that the configuration has been updated between two calls. Take in mind that returns a different value does not mean that the required configuration has been changed, but rather that some configuration has been updated.</p> <p>If you want to check if the content is different you can use the checksum field (it's a sha256 of the configuration content), so it can be useful to deduplicate the documents or decide to launch the watchers callbacks after receiving a different namespace identifier.</p> <h2 id=get>Get</h2> <p>This method allow retrieve a configuration and the protobuf definition is:</p> <div class=codehilite><pre><span></span><code><span class=kd>message</span> <span class=nc>GetRequest</span> <span class=p>{</span>
  <span class=kt>string</span> <span class=na>root_path</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=k>repeated</span> <span class=n>Label</span> <span class=na>labels</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=c1>// the version of the configuration to retrieve, it retrieve the latest</span>
  <span class=c1>// version with a zero value and the proper version otherwise.</span>
  <span class=kt>uint32</span> <span class=na>version</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
  <span class=kt>string</span> <span class=na>document</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
  <span class=n>LogLevel</span> <span class=na>log_level</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>message</span> <span class=nc>GetResponse</span> <span class=p>{</span>
  <span class=kt>uint64</span> <span class=na>namespace_id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=c1>// the returned version, it&#39;s the last version if the asked version was the zero.</span>
  <span class=kt>uint32</span> <span class=na>version</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=k>repeated</span> <span class=n>Element</span> <span class=na>elements</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
  <span class=c1>// A checksum of the file content, being a sha256 checksum the current implementation</span>
  <span class=kt>bytes</span> <span class=na>checksum</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
  <span class=k>repeated</span> <span class=n>Log</span> <span class=na>logs</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
  <span class=c1>// The origin files of the composed config &amp; logs</span>
  <span class=k>repeated</span> <span class=n>Source</span> <span class=na>sources</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h2 id=update>Update</h2> <p>This method allow notify that a configuration file has been changed. It's necessary to specify that the updates comply with three properties: atomicity because all the configuration changes are visible at the same time, consistency because if some configuration file is bad formed one of them will be updated and isolation because it's possible retrieve the configurations like in some snapshot (at least for some time).</p> <div class=codehilite><pre><span></span><code><span class=kd>message</span> <span class=nc>UpdateRequest</span> <span class=p>{</span>
  <span class=c1>// the root path of the namespace that has been changed.</span>
  <span class=kt>string</span> <span class=na>root_path</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=c1>// the list of paths to check for changes, this apply to creations,</span>
  <span class=c1>// modifications and deletions.</span>
  <span class=k>repeated</span> <span class=kt>string</span> <span class=na>relative_paths</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=c1>// reload all the config files of the namespace, if this flag is</span>
  <span class=c1>// on the relative_paths are ignored</span>
  <span class=kt>bool</span> <span class=na>reload</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>message</span> <span class=nc>UpdateResponse</span> <span class=p>{</span>
  <span class=kt>uint64</span> <span class=na>namespace_id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=kd>enum</span> <span class=n>Status</span> <span class=p>{</span>
    <span class=na>OK</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=na>ERROR</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>Status</span> <span class=na>status</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=c1>// the new version.</span>
  <span class=kt>uint32</span> <span class=na>version</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h2 id=watch>Watch</h2> <p>To avoid sporadic requests to the service to detect configuration changes it's possible watch some configuration documents, it this case a stream is created and the service will send the new configuration when some change take place.</p> <div class=codehilite><pre><span></span><code><span class=kd>message</span> <span class=nc>WatchRequest</span> <span class=p>{</span>
  <span class=c1>// the uid to assign to the watcher (this is assigned by the client).</span>
  <span class=kt>uint32</span> <span class=na>uid</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=c1>// if the purpose of the call is remove the watcher with the provided uid.</span>
  <span class=kt>bool</span> <span class=na>remove</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=c1>// the root path of the namespace to obtain the configuration.</span>
  <span class=kt>string</span> <span class=na>root_path</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
  <span class=c1>// the list of labels to watch.</span>
  <span class=k>repeated</span> <span class=n>Label</span> <span class=na>labels</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
  <span class=c1>// document to watch.</span>
  <span class=kt>string</span> <span class=na>document</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
  <span class=n>LogLevel</span> <span class=na>log_level</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>message</span> <span class=nc>WatchResponse</span> <span class=p>{</span>
  <span class=kd>enum</span> <span class=n>Status</span> <span class=p>{</span>
    <span class=na>OK</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=na>ERROR</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=na>UID_IN_USE</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
    <span class=c1>// the provided uid don&#39;t exists in the system.</span>
    <span class=na>UNKNOWN_UID</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
    <span class=c1>// the provided uid has been removed, keep in mind that it&#39;s possible</span>
    <span class=c1>// to have career conditions in this method if:</span>
    <span class=c1>// - a file has been changed and processing of the watcher has begun</span>
    <span class=c1>// - an watcher has been requested to be removed</span>
    <span class=c1>// - it&#39;s returned that the watcher has been removed</span>
    <span class=c1>// - a configuration with the removed watcher identifier is returned</span>
    <span class=c1>// PS: the server could remove the watcher if the namespace has been</span>
    <span class=c1>// deleted and it&#39;s the client responsibility to re-register if it</span>
    <span class=c1>// wish to do so</span>
    <span class=na>REMOVED</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
    <span class=c1>// the provided token don&#39;t have the permisions to watch the asked document.</span>
    <span class=na>PERMISSION_DENIED</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
    <span class=c1>// some of the provided arguments are invalid.</span>
    <span class=na>INVALID_ARGUMENT</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>Status</span> <span class=na>status</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=kt>uint32</span> <span class=na>uid</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=kt>uint64</span> <span class=na>namespace_id</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
  <span class=c1>// the returned version, it&#39;s the last version if the asked version was the zero.</span>
  <span class=kt>uint32</span> <span class=na>version</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
  <span class=k>repeated</span> <span class=n>Element</span> <span class=na>elements</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
  <span class=c1>// A checksum of the file content, being a sha256 checksum the current implementation</span>
  <span class=kt>bytes</span> <span class=na>checksum</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
  <span class=k>repeated</span> <span class=n>Log</span> <span class=na>logs</span> <span class=o>=</span> <span class=mi>7</span><span class=p>;</span>
  <span class=c1>// The origin files of the composed config &amp; logs</span>
  <span class=k>repeated</span> <span class=n>Source</span> <span class=na>sources</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h2 id=trace>Trace</h2> <p>To know if some service is using some document it's possible to add traces that will be activated when certain conditions are met.</p> <div class=codehilite><pre><span></span><code><span class=c1>// The trace request parameters can be seen as a python conditional like</span>
<span class=c1>//   (labels is empty or labels is a subset of A)</span>
<span class=c1>//   and (document is empty or document == B)</span>
<span class=c1>// where</span>
<span class=c1>//   A is a label got/watched</span>
<span class=c1>//   B is a document got/watched</span>
<span class=kd>message</span> <span class=nc>TraceRequest</span> <span class=p>{</span>
  <span class=c1>// the root path of the namespace where trace the configuration.</span>
  <span class=kt>string</span> <span class=na>root_path</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=c1>// the list of labels to trace, if some document with one of them</span>
  <span class=c1>// is asked it will be returned</span>
  <span class=k>repeated</span> <span class=n>Label</span> <span class=na>labels</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=c1>// the document to trace, in case it is not defined it will not be used</span>
  <span class=c1>// in the query</span>
  <span class=kt>string</span> <span class=na>document</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>message</span> <span class=nc>TraceResponse</span> <span class=p>{</span>
  <span class=kd>enum</span> <span class=n>Status</span> <span class=p>{</span>
    <span class=na>RETURNED_ELEMENTS</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=na>ERROR</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=na>ADDED_WATCHER</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
    <span class=na>EXISTING_WATCHER</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
    <span class=na>REMOVED_WATCHER</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>Status</span> <span class=na>status</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=kt>uint64</span> <span class=na>namespace_id</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=kt>uint32</span> <span class=na>version</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
  <span class=k>repeated</span> <span class=n>Label</span> <span class=na>labels</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
  <span class=kt>string</span> <span class=na>document</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h2 id=run-garbage-collector>Run garbage collector</h2> <p>This is a administration method which allows for finer control of the garbage collector although it is not necessary to use it for normal use.</p> <div class=codehilite><pre><span></span><code><span class=kd>message</span> <span class=nc>RunGCRequest</span> <span class=p>{</span>
  <span class=kd>enum</span> <span class=n>Type</span> <span class=p>{</span>
    <span class=na>CACHE_GENERATION_0</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=na>CACHE_GENERATION_1</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=na>CACHE_GENERATION_2</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
    <span class=na>DEAD_POINTERS</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
    <span class=na>NAMESPACES</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
    <span class=na>VERSIONS</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>Type</span> <span class=na>type</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=kt>uint32</span> <span class=na>max_live_in_seconds</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>message</span> <span class=nc>RunGCResponse</span> <span class=p>{</span>
<span class=p>}</span>
</code></pre></div> <h1 id=metrics>Metrics</h1> <p>The server expose some metrics through a prometheus client, some of this metrics are:</p> <ul> <li>The quantile 0.5, 0.9 and 0.99 of the internal threads (the stats are sampled).</li> <li>Some internal stats.</li> </ul> </div> </div> <div class="column  is-3-tablet is-2-widescreen"> <div class=sticky> <nav class=toc-container> <nav id=toc class=toc data-toggle=toc> <ul class="nav navbar-nav"> <li><a class="nav-link js-scroll-trigger" href=#getting-started>Getting Started</a><ul class="nav navbar-nav"><li><a class="nav-link js-scroll-trigger" href=#prerequisites>Prerequisites</a></li><li><a class="nav-link js-scroll-trigger" href=#execution>Execution</a></li></ul><li><a class="nav-link js-scroll-trigger" href=#configuration>Configuration</a><ul class="nav navbar-nav"><li><a class="nav-link js-scroll-trigger" href=#labels>Labels</a></li><li><a class="nav-link js-scroll-trigger" href=#tags>Tags</a></li><li><a class="nav-link js-scroll-trigger" href=#special-files>Special files</a></li><li><a class="nav-link js-scroll-trigger" href=#restrictions>Restrictions</a></li><li><a class="nav-link js-scroll-trigger" href=#debug>Debug</a></li></ul><li><a class="nav-link js-scroll-trigger" href=#access-control-lists>Access Control Lists</a><ul class="nav navbar-nav"><li><a class="nav-link js-scroll-trigger" href=#tokens>Tokens</a></li><li><a class="nav-link js-scroll-trigger" href=#policies>Policies</a></li></ul><li><a class="nav-link js-scroll-trigger" href=#api>API</a><ul class="nav navbar-nav"><li><a class="nav-link js-scroll-trigger" href=#get>Get</a></li><li><a class="nav-link js-scroll-trigger" href=#update>Update</a></li><li><a class="nav-link js-scroll-trigger" href=#watch>Watch</a></li><li><a class="nav-link js-scroll-trigger" href=#trace>Trace</a></li><li><a class="nav-link js-scroll-trigger" href=#run-garbage-collector>Run garbage collector</a></li></ul><li><a class="nav-link js-scroll-trigger" href=#metrics>Metrics</a> </ul> </nav> </nav> </div> </div> </div> </section> </div> <footer class=footer> <div class="content has-text-centered"> <p><p>© <a href=https://gonlo2.github.io/blog/en/about_me/ >Juan Manuel Fdez</a> 2020. Made with curiosity, coffee and neovim.</p> </p> <div> <a class=is-link href=https://github.com/Gonlo2/mhconfig> <span class="title icon has-text-grey-darker"> <i class="fab fa-github"></i> </span> </a> </div> </div> </footer> </div> <script defer src=/mhconfig/vendor/jquery/jquery.min.js></script> <script defer src=/mhconfig/vendor/jquery-easing/jquery.easing.min.js></script> <script defer src=/mhconfig/vendor/jquery-lazy/jquery.lazy.min.js></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-174941702-1"></script> <script defer src=/mhconfig/js/main.min.js></script> </body> </html>